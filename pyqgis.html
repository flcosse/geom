<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script type="text/javascript">
    $(function(){
    $("#footer").load("footer.html"); 
    });
      </script>
  <link rel="stylesheet" href="style.css">
  <meta charset="utf-8">
  <title>PyQGIS</title>
  <link rel="shortcut icon" href="image/planet-earth.png" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
</head>
<body>
  <link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/atom-one-light.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/python.min.js"></script>

  <script>hljs.initHighlightingOnLoad();</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
  <div class="container-fluid" id="footer"></div>
    <div class="block">
    <div class="article">
      <h1>Tracé 3D avec PyQGIS et Plotly</h1>
      <div class="tags">
      <h4> <span class="badge bg-secondary">Python</span></h4>
      <h4> <span class="badge bg-secondary">PyQGIS</span></h4>
      <h4> <span class="badge bg-secondary">3D</span></h4>
      <h4> <span class="badge bg-secondary" style="float:none">Plotly</span></h4>
  </div>
       <p >Import d'un MNT et du tracé des cours d'eau. Des points sont placés le long de la ligne qui servira à prélever (1) l'altitude et (2) les coordonnées X et Y. Ces points seront ensuite intégrés dans un graphique en 3D.</p> 
       <div class="fi" style="text-align: center;padding:4vh">
       <iframe src="profil2.html"scrolling="no"  frameBorder="0" height="60%" width="60%" title=""></iframe>
    </div>
       <pre><code class="python">import plotly.graph_objects as go
import uuid
import numpy as np

file  = str(uuid.uuid4())
fleuve = "'La Seine'"
sub = "NomEntiteH ILIKE "+fleuve+" and Classe = 1"
path = f"C:/Users/Florian/Desktop/département/CoursEau_FXX.shp|subset={sub}"
iface.addVectorLayer(path,"","ogr")
line = QgsVectorLayer(path,"","ogr")
d = QgsDistanceArea()
d.setEllipsoid('WGS84')

for feat in line.getFeatures():
    dist_point = (d.convertAreaMeasurement(d.measureLength(feat.geometry()),100))
uri = f"C:/Users/Florian/Desktop/département/Relevés.shp"
processing.run("native:pointsalonglines", 
{'INPUT':path,
'DISTANCE':dist_point/30000000,
'START_OFFSET':0,
'END_OFFSET':0,
'OUTPUT':uri})

iface.addVectorLayer(uri,"","ogr")
iface.addRasterLayer(r"C:\Users\Florian\Downloads\EUDEM\eu_dem_v11_E30N20.TIF","Raster","gdal")
listLayers=QgsProject.instance().mapLayersByName('Relevés')

layerCrs = QgsCoordinateReferenceSystem.fromEpsgId(4326)
listLayers[0].setCrs(layerCrs)

uri = f"C:/Users/Florian/Desktop/département/BIN/{file}.shp"

processing.run("native:rastersampling", 
{'INPUT':'C:/Users/Florian/Desktop/département/Relevés.shp',
'RASTERCOPY':r"C:\Users\Florian\Downloads\EUDEM\eu_dem_v11_E30N20.TIF",
'COLUMN_PREFIX':'SAMPLE_',
'OUTPUT':uri})

iface.addVectorLayer(uri,"","ogr")

x = []
y = []
layer = QgsVectorLayer(uri,"points","ogr")

for i in layer.getFeatures():
    geom = i.geometry()
    x.append(geom.asPoint().x())
    y.append(geom.asPoint().y())

z_ = [f["SAMPLE_1"] for f in layer.getFeatures()]
z = [i if type(i) == float else 0 for i in z_]
names = [layer.name() for layer in QgsProject.instance().mapLayers().values()]
fleuve = fleuve.replace("'", "")

fig = go.Figure(
    data=go.Scatter3d(
        x=x,
        y=y,
        z=z,
        marker=dict(
            size=0.01,
            color=z,
            colorscale="Blues",
        ),
        line=dict(color="#497bff", width=8),
    )
)

teinte = 210
gridco = f"rgb({teinte},{teinte},{teinte})"
bc = gridco
fig.update_layout(scene = dict(
                    xaxis = dict(
                         backgroundcolor="#f9f9fa",
                         gridcolor=gridco,
                         showbackground=True,),
                    yaxis = dict(
                        backgroundcolor="#f9f9fa",
                        gridcolor=gridco,
                        showbackground=True,),
                    zaxis = dict(
                        backgroundcolor="#f9f9fa",
                        gridcolor=gridco,
                        showbackground=True,),bgcolor="#f9f9fa"),
                    width=700,
                    margin=dict(
                    r=10, l=10,
                    b=10, t=10)
                  )

fig.update_layout(margin={"r": 0, "l": 0, "b": 0, "t": 60},font=dict(size=13,family="Segoe UI"),)

fig.update_layout(title=f"Tracé 3D : {fleuve}.<br>SCR : WGS 84")
fig.write_html(r"C:\Users\Florian\Desktop\SITE-BS\profil2.html")


</code></pre>
    </div>
</div>

    </body>